<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ž×ž×©×§ ×¢×•×‘×“ - ×ž×¢×¨×›×ª × ×™×”×•×œ ×ž×©×™×ž×•×ª</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">

    <style>
        .token-box{
            background:#f2f2f2;
            padding:10px;
            border-radius:8px;
            margin:10px 0;
            font-size:12px;
            word-break:break-all;
        }
        .copy-btn{
            margin-top:8px;
            background:#4CAF50;
            color:white;
            border:none;
            padding:6px 12px;
            border-radius:6px;
            cursor:pointer;
        }
    </style>
</head>

<body>
<div class="container">

    <div class="header">
        <h1>×”×ž×©×™×ž×•×ª ×©×œ×™</h1>
        <button onclick="logout()" class="logout-btn">×”×ª× ×ª×§</button>
    </div>

    <!-- ðŸ”¥ ×—×“×©: ×ª×¦×•×’×ª ×˜×•×§×Ÿ -->
    <div class="token-box" id="tokenBox" style="display:none">
        <strong>FCM Token:</strong>
        <div id="tokenText"></div>
        <button class="copy-btn" onclick="copyToken()">×”×¢×ª×§ ×˜×•×§×Ÿ</button>
    </div>

    <div class="tasks-section">
        <h2>×”×ž×©×™×ž×•×ª ×©×”×•×§×¦×• ×œ×™</h2>
        <div id="tasks-list"></div>
    </div>

</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, getDocs, doc, updateDoc, query, where, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js';


/* ===============================
   â— ×”×§×•× ×¤×™×’ ×©×œ×š â€“ ×œ× × ×’×¢×ª×™
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyC2gl8SbTx81sZsXPjctfEesfn7PZkKlKk",
  authDomain: "task-management-2beb8.firebaseapp.com",
  projectId: "task-management-2beb8",
  storageBucket: "task-management-2beb8.firebasestorage.app",
  messagingSenderId: "1004663469893",
  appId: "1:1004663469893:web:7344dded39f76143b0702c"
};


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const messaging = getMessaging(app);

const userId = localStorage.getItem('userId');

if (!userId) {
    window.location.href = 'index.html';
}


/* ===============================
   ×”×¨×©××ª ×¤×•×© + ×˜×•×§×Ÿ
================================ */
async function requestNotificationPermission() {
    try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;

        const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');

        const token = await getToken(messaging, {
            vapidKey: 'BB9MsNo5DbhZ1kIBRxeAtnIWxGbFZ7y-xuQbUduwHNOKxVMMfkXad8jJaM-Rjfl7RcI-y9wwAFNB8Bj57BvHSfI',
            serviceWorkerRegistration: registration
        });

        if (token) {

            console.log("FCM Token:", token);

            /* ðŸ”¥ ×”×¦×’×ª ×˜×•×§×Ÿ ×‘×ž×¡×š */
            window.currentToken = token;
            document.getElementById('tokenText').innerText = token;
            document.getElementById('tokenBox').style.display = 'block';

            await setDoc(doc(db, 'fcmTokens', userId), {
                token,
                userId,
                updatedAt: new Date()
            });

            localStorage.setItem('fcmToken', token);
        }

        listenForNotifications();

    } catch (err) {
        console.error(err);
    }
}


/* ===============================
   ×”×¢×ª×§×” ×œ×œ×•×—
================================ */
window.copyToken = async function () {
    const token = window.currentToken || localStorage.getItem('fcmToken');
    await navigator.clipboard.writeText(token);
    alert("×”×˜×•×§×Ÿ ×”×•×¢×ª×§ âœ…");
};


/* ===============================
   ×”×•×“×¢×•×ª ×‘×–×ž×Ÿ ××ž×ª
================================ */
onMessage(messaging, (payload) => {
    new Notification(
        payload.notification?.title || "×”×ª×¨××”",
        { body: payload.notification?.body || "", icon: './icon-192.png' }
    );
});


/* ===============================
   ×©××¨ ×”×§×•×“ ×©×œ×š â€“ ×œ×œ× ×©×™× ×•×™
================================ */
window.logout = () => {
    localStorage.clear();
    window.location.href = 'index.html';
};

requestNotificationPermission();
</script>
</body>
</html>
