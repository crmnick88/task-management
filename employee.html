<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>×”×ž×©×™×ž×•×ª ×©×œ×™</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon-192.png">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

    <link rel="stylesheet" href="./styles.css">

    <style>
        body {
            font-family: Arial;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
        }

        .task-item {
            background: #f3f3f3;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .token-box {
            font-size: 11px;
            word-break: break-all;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="card">
        <h2>×”×ž×©×™×ž×•×ª ×©×œ×™</h2>

        <div class="token-box" id="tokenBox">×˜×•×¢×Ÿ ×˜×•×§×Ÿ...</div>

        <button onclick="copyToken()">×”×¢×ª×§ ×˜×•×§×Ÿ</button>
    </div>

    <div class="card">
        <h3>×”×ž×©×™×ž×•×ª ×©×”×•×§×¦×• ×œ×™</h3>
        <div id="tasks-list"></div>
    </div>

    <script>
        /* ===============================
           ðŸ”¥ Firebase Config (×©×œ×š â€“ ×œ× ×œ×’×¢×ª)
        =============================== */

        const firebaseConfig = {
            apiKey: "AIzaSyC2gI8SbTx81sZsXPjctfEesfn7PZkKlKk",
            authDomain: "task-management-2beb8.firebaseapp.com",
            projectId: "task-management-2beb8",
            storageBucket: "task-management-2beb8.firebasestorage.app",
            messagingSenderId: "1004663469893",
            appId: "1:1004663469893:web:7344dded39f76143b0702c"
        };

        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
        const messaging = firebase.messaging();

        const userId = "employee1";


        /* ===============================
           ðŸ”¥ Service Worker
        =============================== */

        navigator.serviceWorker.register('./firebase-messaging-sw.js');


        /* ===============================
           ðŸ”¥ ×‘×§×©×ª ×”×¨×©××•×ª + ×˜×•×§×Ÿ
        =============================== */

        async function requestPermission() {

            const permission = await Notification.requestPermission();

            if (permission !== 'granted') return;

            const token = await messaging.getToken({
                vapidKey: 'YOUR_VAPID_KEY_HERE'
            });

            if (!token) return;

            document.getElementById('tokenBox').innerText = token;

            await db.collection('fcmTokens').doc(userId).set({
                token,
                userId,
                updatedAt: new Date()
            });

            console.log("Token saved:", token);
        }


        /* ===============================
           ðŸ”¥ ×¤×•×© ×›×©×”××¤×œ×™×§×¦×™×” ×¤×ª×•×—×”
        =============================== */

        messaging.onMessage(payload => {

            console.log("Push received:", payload);

            new Notification(
                payload.notification.title,
                {
                    body: payload.notification.body
                }
            );
        });


        /* ===============================
           ðŸ”¥ ×”××–× ×” ×œ×ž×©×™×ž×•×ª ×‘×–×ž×Ÿ ××ž×ª
        =============================== */

        function listenForTasks() {

            db.collection('tasks')
                .where('userId', '==', userId)
                .onSnapshot(snapshot => {

                    const list = document.getElementById('tasks-list');
                    list.innerHTML = '';

                    snapshot.forEach(doc => {

                        const task = doc.data();

                        const div = document.createElement('div');
                        div.className = 'task-item';

                        div.innerHTML = `
                            <b>${task.title}</b><br>
                            ${task.description || ''}
                        `;

                        list.appendChild(div);
                    });
                });
        }


        /* ===============================
           ðŸ”¥ ×”×¢×ª×§ ×˜×•×§×Ÿ
        =============================== */

        function copyToken() {
            navigator.clipboard.writeText(
                document.getElementById('tokenBox').innerText
            );
            alert("×”×•×¢×ª×§!");
        }


        /* ===============================
           ðŸ”¥ INIT
        =============================== */

        requestPermission();
        listenForTasks();

    </script>

</body>

</html>
